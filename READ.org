#+LATEX_HEADER: \usepackage{xltxtra}
#+LATEX_HEADER: \setmainfont{微软雅黑}
#+LATEX_HEADER: \usepackage{seqsplit}
#+OPTIONS: TeX:t LaTeX:t skip:nil d:nil tasks:nil pri:nil title:t
#+TITLE:  *IEC60870 设计* 

* 简述
 用于 IEC101、IEC103、IEC104 协议通信,可支持主站端、设备端及中转机
应用场合.系统通信传输模式支持平衡模式及非平衡模式传输。整个系统分为链
路模块、APP 系统应用模块及 APP 用户应用模块。链路模块支持串行、网络
物理端口，可单独使用某端口或同时使用两种端口同时工作。可创建具有不同
信息点集的 APP 系统应用模块,APP 系统应用模块与链路模块之间可建立对应
关系。APP 用户应用模块支持不同应用场合下的功能配置.系统采用事件机制，
通过事件,在各模块之间的进行消息传递，实现整个数据交互流程.

* 定义
+ *链路模块<Link_Module>*
  链路模块是设备或主机物理通信端口在链路层的功能集合。通过该模块提供的
  接口,可配置某个物理端口，使其符合 870 系列通信协议的参数要求,能对传
  输数据进行封装,使数据格式满足870协议要求。
+ *APP 系统应用模块<App_Module>*
  APP系统应用模块为应用层的功能集合。可配置应用层的配置参数，封装用户
  数据，管理系统各类数据通信过程。
+ *APP 用户应用模块<App_User_Module>*
  创建、读写、控制信息点的功能集合，提供具体设备或应用场合的信息点组
  集合与符合870协议格式的数据包两者之间的相互转化接口。
+ *用户<User>*
 在不同的应用场合下，<用户>含义不同。应用于主站端时为控制站功能接口，
 应用于设备时为客户站功能接口，应用于中转机时具有上述所有功能接口
+ *事件 消息<Event MSG>*
 系统中所有的操作、状态改变定义为事件,消息为该事件具有的信息,
 例如合分闸控制时，消息保护控制发起者,时间,状态等

* 关联
在不同的应用场合下,系统中存在的各个模块实例数量不同,各实例之间的关联
也不同. (N为物理端口类型数量 M为物理端口数量和 P为APP模块数量)
+ *设备端应用场合* 
 该场合下,设备可能具有N个不同类型的物理通信端口,但设备的信息对象组
 唯一。 因此，该场合下系统中具有M个链路模块实例,APP实例模块的数量
 等于物理端口类型的数量N,即同类型的链路模块实例对应一个独立APP实例
 模块。
+ *主站端应用场合* 
 该场合下,设备可能具有N个不同类型的物理通信端口,并且需要与不同的客户
 端进行交互。因此,该场合下系统中不仅具有M个物理端口链路模块实例，而且
 APP系统应用模块实例可根据应用需要配置,当一个APP模块对应一个链路模块时，
 APP模块数量P等于M。信息对象组数量等于APP模块的数量P
+ *中转机应用场合* 
 该场合既支持设备端，也支持主站端应用。当不同 APP 系统应用模块需进行
 数据交换时,可通过消息机制在APP模块之间传递,不涉及链路模块。
APP 用户应用模块功能分为三部分，一个为通用功能，第二个为客户端功能，
第三个为主站端功能。另外 870 协议有非平衡传输模式与平衡传输模式，
不同的传输模式与应用场合决定了 APP 用户应用模块的功能配置。在客
户端应用场合、非平衡模式下,APP 用户应用模块的功能除通用功能外，
仅包括客户端功能；在主站应用场合、非平衡模式下，除通用功能外，仅
包括主站端功能；在平衡模式或中转机场合下，所有功能都支持。

* 事件 消息
** 概括
   系统中一个完整的事件<Event>由下列元素组成
   + 事件发起者(sender)
     该事件的产生对象。例如在101中某个串行模块请求1级数据时，此模块为
     事件发起者
   + 事件接收者(recver)
     该事件的接收对象。上例中，串行模块所关联的APP系统应用模块为接收者
   + 主事件类型(msg_type)
     主事件类型为一组宏定义，包含
     - CREATE
     - OPEN
     - CLOSE
     - WRITE
     - READ
     - CONTROL
   + 子事件类型(sub_msg_type)
     主事件类型的补充定义，各个模块不同
   + 事件包含消息(msg)
     该事件传递的信息
   + 回收标志(auto_free)
     传递的信息是否回收

* 链路模块
  链路模块是对设备或主机物理通信端口类化。该模块实现对 870 规约中
  链路层规定功能，并提供了针对物理层端口发送数据与接收数据的接口。
  对实际物理端口的配置由用户完成，之后系统初始化时，用户还需实现
  收发数据两个接口。链路模块分串行链路模块、网络链路模块，分别
  对应串口与网口。
  
** 串行链路模块

*** 数据结构说明
 - *serial_link_cfg*
#+CAPTION: 串行链路配置信息
| 名称          | 数据类型 | 说明                     |
|---------------+----------+--------------------------|
| link_addr     | int      | 链路地址                 |
|---------------+----------+--------------------------|
| link_addr_len | int      | 链路地址占用字节长度     |
|---------------+----------+--------------------------|
| double_dir    | int      | 设置平衡模式或非平衡模式 |
|---------------+----------+--------------------------|
| recv_buff     | char*    | 接收数据存储区           |
|---------------+----------+--------------------------|
| send_buff     | char*    | 发送数据存储区           |
|---------------+----------+--------------------------|
| prev_sent_buf | char*    | 上一次发送数据           |
|---------------+----------+--------------------------|
| prev_sent_len | int      | 上次发送数据的长度       |
|---------------+----------+--------------------------|
|               |          |                          |
- *serial_link_info*
#+CAPTION: 串行链路运行信息
| 名称         | 数据类型         | 说明                   |
|--------------+------------------+------------------------|
| cfg          | serial_link_cfg* | 对应配置信息           |
|--------------+------------------+------------------------|
| acd_tag      | int              | 一类数据标识           |
|--------------+------------------+------------------------|
| app_tag      | int              | 二类数据标识           |
|--------------+------------------+------------------------|
| fcb          | int              | 链路控制域 FCB 位        |
|--------------+------------------+------------------------|
| serial_tid   | osthreadid       | 启用多任务运行时,      |
|              |                  | 该链路工作任务 ID       |
|--------------+------------------+------------------------|
| serial_event | osmessageQid     | 启用多任务运行时，     |
|              |                  | 该链路任务绑定消息邮箱 |
|--------------+------------------+------------------------|
|              |                  |                        |

*** 宏说明
+ 链路分发处理判断结果定义
  工作任务通过解析收到数据中的控制域数据，标识下一步的处理步骤
  #+CAPTION: 表一
| 宏名          | 定义 | 说明                  |
|---------------+------+-----------------------|
| NO_AWS        |    0 | 无需应答              |
|---------------+------+-----------------------|
| INVAILD_FCB   |    1 | 无效 FCB 计数           |
|---------------+------+-----------------------|
| TO_LINK       |    2 | 发送至某个 LINK 处理    |
|---------------+------+-----------------------|
| TO_LINK_REQ   |    3 | 链路请求处理          |
|---------------+------+-----------------------|
| TO_APP_FIRST  |    4 | 至 APP 模块一类数据处理 |
|---------------+------+-----------------------|
| TO_APP_SECOND |    5 | 至 APP 模块二类数据处理 |
|---------------+------+-----------------------|
| TO_APP_USER   |    6 | 至 APP 模块用户数据处理 |
|---------------+------+-----------------------|
|               |      |                       |

*** 功能
+ 创建链路模块实例
+ 初始化某个链路模块实例
+ 清除链路信息
+ 链路复位功能
+ 链路地址设置及读取
+ 设置传输模式
+ 数据帧链路格式校验 包括固定帧长格式、非固定帧长格式
+ 接收数据处理
+ 封装数据
  
